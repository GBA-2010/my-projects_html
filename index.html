<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–∏–¥ –ø–æ –°–∞–Ω—å–µ (Sanya Ultimate Guide)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #70757a;
            --accent-color: #4285F4;
            
            /* Nav Variables */
            --nav-bg: #ffffff;
            --nav-active-bg: #202124; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
            --nav-active-text: #ffffff;
            --nav-height: 70px;
            
            --border-color: #e0e0e0;
            --header-height: 60px;
        }

        /* Adventure Theme Variables */
        body.adventure-mode {
            --bg-color: #1a1d21;
            --card-bg: #252930;
            --text-color: #e8eaed;
            --text-secondary: #9aa0a6;
            
            --nav-bg: #252930;
            --nav-active-bg: #8ab4f8; /* –°–≤–µ—Ç–ª—ã–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ */
            --nav-active-text: #202124;
            
            --border-color: #3c4043;
            --accent-color: #8ab4f8;
        }

        /* Reset & Base */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: var(--card-bg);
            z-index: 100;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            transition: background 0.3s;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .header-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            margin-left: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ê—ç—Ä–æ–ø–æ—Ä—Ç –≤ —Ö–µ–¥–µ—Ä–µ */
        .btn-airport-header {
            color: var(--accent-color) !important;
            background: rgba(66, 133, 244, 0.1) !important;
        }

        /* Main Content */
        main {
            flex: 1;
            position: relative;
            margin-top: var(--header-height);
            margin-bottom: var(--nav-height); /* Space for bottom nav */
            overflow: hidden;
            background: var(--bg-color);
        }

        .view-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
        }

        .view-section.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 1;
        }

        /* Map Section */
        #map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        body.adventure-mode .leaflet-layer {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        /* Map Chips Filter */
        .map-filters {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 10px;
            z-index: 10;
            scrollbar-width: none;
        }

        .chip {
            display: inline-block;
            padding: 6px 16px;
            margin-right: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 18px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .chip.active {
            background: #e8f0fe;
            color: #1967d2;
            border-color: #e8f0fe;
        }
        
        body.adventure-mode .chip.active {
            background: #8ab4f8;
            color: #202124;
        }

        /* Drawer */
        .drawer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px;
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 20;
            color: var(--text-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }

        .drawer.open { transform: translateY(0); }

        .drawer-title { font-size: 1.4rem; margin: 0; color: var(--text-color); }
        .drawer-subtitle { color: var(--text-secondary); font-size: 0.95rem; margin-top: 4px; }
        .drawer-actions { display: flex; gap: 10px; margin-top: 20px; }

        .btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: #1a73e8; color: white; }
        .btn-taxi { background: #fbbc04; color: #3c4043; }
        .btn-close { 
            background: var(--bg-color); 
            color: var(--text-secondary); 
            width: 30px; height: 30px; 
            border-radius: 50%; padding: 0; 
        }

        /* Lists */
        .list-grid { padding: 16px; display: grid; gap: 16px; }

        .card-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .big-cn-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d93025;
            margin: 8px 0;
        }

        /* Floating Bottom Navigation */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            background: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            width: 100%;
            height: 100%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            transition: margin 0.3s;
        }
        
        .nav-item span {
            font-size: 0.75rem;
            transition: opacity 0.2s;
        }

        /* Floating Active State */
        .nav-item.active {
            color: var(--text-color); /* Text color stays relatively neutral or primary */
        }
        
        /* The "Floating Dark Circle" Effect */
        .nav-item.active i {
            background: var(--nav-active-bg);
            color: var(--nav-active-text);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px; /* Lift icon up */
            transform: translateY(-15px); /* Physically move up */
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            border: 4px solid var(--nav-bg); /* Cutout effect */
        }

        .nav-item.active span {
            position: absolute;
            bottom: 12px;
            font-weight: 600;
            color: var(--text-color);
        }


        /* Panels */
        .panel {
            position: absolute;
            top: var(--header-height);
            left: 0;
            width: 100%;
            background: var(--card-bg);
            padding: 20px;
            transform: translateY(-150%);
            transition: transform 0.3s ease;
            z-index: 50;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .panel.open { transform: translateY(0); }

        .setting-group {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .form-input {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color); color: var(--text-color);
            margin-bottom: 10px;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Fullscreen Modal */
        .fs-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-bg); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .fs-modal.active { display: flex; }
        .fs-text { color: var(--text-color); font-size: 4rem; font-weight: 900; margin-bottom: 40px; }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo">–ì–∏–¥ –ø–æ –°–∞–Ω—å–µ üå¥</div>
        <div class="header-actions">
            <!-- Airport moved here -->
            <button onclick="switchView('airports', null)" class="btn-airport-header"><i class="fas fa-plane"></i></button>
            <button onclick="togglePanel('search')"><i class="fas fa-search"></i></button>
            <button onclick="togglePanel('settings')"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- Settings Panel -->
    <div id="settings-panel" class="panel">
        <h3 style="margin-top:0; color:var(--text-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="setting-group">
            <label style="display:block; margin-bottom:8px;">–õ–æ–∫–∞—Ü–∏—è</label>
            <input type="text" class="form-input" placeholder="–°—Ç—Ä–∞–Ω–∞" value="–ö–∏—Ç–∞–π">
            <input type="text" class="form-input" placeholder="–ì–æ—Ä–æ–¥" value="–°–∞–Ω—å—è">
        </div>
        <div class="setting-group" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <label style="margin:0;">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ (–¢–µ–º–∞)</label>
                <small style="color:var(--text-secondary); display:block;">–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</small>
            </div>
            <label class="switch">
                <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="closePanel('settings')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- Search Panel -->
    <div id="search-panel" class="panel">
        <input type="text" class="form-input" placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç..." oninput="performSearch(this.value)">
    </div>

    <!-- Main Content -->
    <main>
        <!-- Map View -->
        <div id="view-map" class="view-section active">
            <div id="map-container">
                <div class="map-filters">
                    <span class="chip active" onclick="filterMap('all', this)">–í—Å–µ</span>
                    <span class="chip" onclick="filterMap('attraction', this)">–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ</span>
                    <span class="chip" onclick="filterMap('park', this)">–ü–∞—Ä–∫–∏</span>
                    <span class="chip" onclick="filterMap('hotel', this)">–û—Ç–µ–ª–∏</span>
                    <span class="chip" onclick="filterMap('shop', this)">–®–æ–ø–∏–Ω–≥</span>
                    <span class="chip" onclick="filterMap('food', this)">–ï–¥–∞</span>
                </div>
                <div id="map"></div>
                
                <!-- Drawer -->
                <div id="location-drawer" class="drawer">
                    <div class="drawer-header" style="display:flex; justify-content:space-between;">
                        <div>
                            <h3 id="loc-name" class="drawer-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                            <div id="loc-cn" class="drawer-subtitle">–ö–∏—Ç–∞–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
                        </div>
                        <button class="btn-close" onclick="closeDrawer()">‚úï</button>
                    </div>
                    <div class="drawer-actions">
                        <button class="btn btn-taxi" onclick="showTaxiBig()">
                            <i class="fas fa-taxi"></i> –¢–∞–∫—Å–∏
                        </button>
                        <button class="btn btn-primary" onclick="buildRouteToLoc()">
                            <i class="fas fa-location-arrow"></i> –ú–∞—Ä—à—Ä—É—Ç
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Airports View -->
        <div id="view-airports" class="view-section">
            <div class="list-grid">
                <div class="card-item">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; font-size:1.1rem; color:var(--text-color);">–ê—ç—Ä–æ–ø–æ—Ä—Ç –§–µ–Ω–∏–∫—Å</h3>
                        <i class="fas fa-plane-arrival" style="color:var(--accent-color); font-size:1.5rem;"></i>
                    </div>
                    <p style="color:var(--text-secondary); margin:5px 0;">SYX ‚Ä¢ Sanya Phoenix International</p>
                    <div class="big-cn-text">‰∏â‰∫öÂá§Âá∞ÂõΩÈôÖÊú∫Âú∫</div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-taxi" style="flex:1; font-size:0.8rem;" onclick="showFullscreen('‰∏â‰∫öÂá§Âá∞ÂõΩÈôÖÊú∫Âú∫')">–¢–∞–∫—Å–∏—Å—Ç—É</button>
                        <button class="btn btn-primary" style="flex:1; font-size:0.8rem;" onclick="jumpToMap(18.3039, 109.4124, '–ê—ç—Ä–æ–ø–æ—Ä—Ç –§–µ–Ω–∏–∫—Å')">–ù–∞ –∫–∞—Ä—Ç–µ</button>
                    </div>
                </div>
                
                <div class="card-item" style="opacity:0.7;">
                    <h3 style="margin:0; font-size:1.1rem; color:var(--text-color);">–•–∞–π–∫–æ—É –ú—ç–π–ª–∞–Ω—å</h3>
                    <p style="color:var(--text-secondary); margin:5px 0;">HAK ‚Ä¢ Haikou Meilan (–°–∫–æ—Ä–æ—Å—Ç–Ω–æ–π –ø–æ–µ–∑–¥)</p>
                    <div class="big-cn-text">Êµ∑Âè£ÁæéÂÖ∞ÂõΩÈôÖÊú∫Âú∫</div>
                </div>
            </div>
        </div>

        <!-- Food View -->
        <div id="view-food" class="view-section">
            <div class="list-grid" id="food-list"></div>
        </div>

        <!-- Phrases View -->
        <div id="view-phrases" class="view-section">
            <div class="list-grid" id="phrases-list"></div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav>
        <button class="nav-item active" onclick="switchView('map', this)">
            <i class="fas fa-map-marked-alt"></i>
            <span>–ö–∞—Ä—Ç–∞</span>
        </button>
        <button class="nav-item" onclick="switchView('food', this)">
            <i class="fas fa-utensils"></i>
            <span>–ï–¥–∞</span>
        </button>
        <button class="nav-item" onclick="switchView('phrases', this)">
            <i class="fas fa-comments"></i>
            <span>–§—Ä–∞–∑—ã</span>
        </button>
    </nav>

    <!-- Fullscreen Modal -->
    <div id="fs-modal" class="fs-modal">
        <div id="fs-content" class="fs-text">TEXT</div>
        <button class="btn btn-close" style="width:auto; padding:10px 30px; border:1px solid var(--border-color);" onclick="closeFsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        // --- DATA ---
        // Added more hotels to ensure they are visible on filter
        const mainLocations = [
            { id: 1, name: "–¶–µ–Ω—Ç—Ä –°–∞–Ω—å–∏", cn: "‰∏â‰∫öÂ∏Ç‰∏≠ÂøÉ", lat: 18.2528, lng: 109.5119, type: "shop" },
            { id: 2, name: "–ü–∞—Ä–∫ –û–ª–µ–Ω—å", cn: "ÈπøÂõûÂ§¥ÂÖ¨Âõ≠", lat: 18.2345, lng: 109.5152, type: "park" },
            { id: 3, name: "–î–∞–¥—É–Ω—Ö–∞–π", cn: "Â§ß‰∏úÊµ∑", lat: 18.2248, lng: 109.5262, type: "attraction" },
            { id: 4, name: "–ù–æ—á–Ω–æ–π —Ä—ã–Ω–æ–∫ Yiheng", cn: "‰∫øÊÅíÂ§úÂ∏Ç", lat: 18.2612, lng: 109.5045, type: "shop" },
            { id: 5, name: "–•—Ä–∞–º –ù–∞–Ω—å—à–∞–Ω—å", cn: "ÂçóÂ±±ÂØ∫", lat: 18.2936, lng: 109.2081, type: "attraction" },
            { id: 6, name: "–ö—Ä–∞–π –°–≤–µ—Ç–∞", cn: "Â§©Ê∂ØÊµ∑Ëßí", lat: 18.2965, lng: 109.3468, type: "attraction" },
            { id: 7, name: "–ó–∞–ª–∏–≤ –Ø–ª–æ–Ω–≥", cn: "‰∫öÈæôÊπæ", lat: 18.2201, lng: 109.6521, type: "attraction" },
            
            // HOTELS
            { id: 8, name: "–û—Ç–µ–ª—å –ê—Ç–ª–∞–Ω—Ç–∏—Å", cn: "‰∏â‰∫ö‰∫öÁâπÂÖ∞ËíÇÊñØ", lat: 18.3639, lng: 109.7428, type: "hotel" },
            { id: 101, name: "Mandarin Oriental", cn: "‰∏â‰∫öÊñáÂçé‰∏úÊñπÈÖíÂ∫ó", lat: 18.2180, lng: 109.5350, type: "hotel" },
            { id: 102, name: "Ritz-Carlton Yalong Bay", cn: "ÈáëËåÇ‰∏â‰∫ö‰∫öÈæôÊπæ‰∏ΩÊÄùÂç°Â∞îÈ°øÈÖíÂ∫ó", lat: 18.2150, lng: 109.6450, type: "hotel" },
            { id: 103, name: "Sanya Marriott", cn: "‰∏â‰∫ö‰∫öÈæôÊπæ‰∏áË±™Â∫¶ÂÅáÈÖíÂ∫ó", lat: 18.2185, lng: 109.6550, type: "hotel" },
            { id: 104, name: "Pullman Yalong Bay", cn: "‰∏â‰∫ö‰∫öÈæôÊπæÊôÆÂ∞îÊõºÂ∫¶ÂÅáÈÖíÂ∫ó", lat: 18.2250, lng: 109.6600, type: "hotel" },
            { id: 105, name: "InterContinental Sanya", cn: "‰∏â‰∫öÂçäÂ±±ÂçäÂ≤õÊ¥≤ÈôÖÂ∫¶ÂÅáÈÖíÂ∫ó", lat: 18.2100, lng: 109.5000, type: "hotel" },

            { id: 9, name: "–î—å—é—Ç–∏ –§—Ä–∏ –•–∞–π—Ç–∞–Ω–≥", cn: "‰∏â‰∫öÂõΩÈôÖÂÖçÁ®éÂüé", lat: 18.3815, lng: 109.7366, type: "shop" },
            { id: 10, name: "–û—Å—Ç—Ä–æ–≤ –ü–∏—Ä–∞—Ç–æ–≤", cn: "ËúàÊîØÊ¥≤Â≤õ", lat: 18.3108, lng: 109.7619, type: "attraction" },
            { id: 11, name: "–ü–µ—Ä–≤—ã–π –†—ã–Ω–æ–∫", cn: "Á¨¨‰∏ÄÂ∏ÇÂú∫", lat: 18.2452, lng: 109.5058, type: "food" },
            { id: 14, name: "–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –ª–µ—Å –Ø–Ω–æ–¥–∞", cn: "ÂëÄËØ∫ËææÈõ®Êûó", lat: 18.4418, lng: 109.6268, type: "park" }
        ];

        const foods = [
            { name: "–ö—É—Ä–∏—Ü–∞ –í—ç–Ω—å—á–∞–Ω", cn: "ÊñáÊòåÈ∏°", icon: "üçó" },
            { name: "–ö—Ä–∞–± –•—ç–ª–µ", cn: "Âíå‰πêËüπ", icon: "ü¶Ä" },
            { name: "–ö–æ–∫–æ—Å–æ–≤—ã–π —Ä–∏—Å", cn: "Ê§∞Â≠êÈ•≠", icon: "ü••" },
            { name: "–ö–æ–∑–∞ –î—É–Ω—à–∞–Ω—å", cn: "‰∏úÂ±±Áæä", icon: "ü•©" },
            { name: "–£—Ç–∫–∞ –¶–∑—è—Ü–∑–∏", cn: "Âä†ÁßØÈ∏≠", icon: "ü¶Ü" },
            { name: "–õ–∞–ø—à–∞ –•–∞–π–Ω–∞–Ω—å", cn: "Êµ∑ÂçóÁ≤â", icon: "üçú" },
            { name: "–ú–∞–Ω–≥–æ", cn: "ËäíÊûú", icon: "ü•≠" }
        ];

        const phrases = [
            { ru: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", cn: "‰Ω†Â•Ω", pinyin: "N«ê h«éo" },
            { ru: "–°–ø–∞—Å–∏–±–æ", cn: "Ë∞¢Ë∞¢", pinyin: "Xi√®xi√®" },
            { ru: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?", cn: "Â§öÂ∞ëÈí±?", pinyin: "Du≈çsh«éo qi√°n?" },
            { ru: "–°–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ", cn: "Â§™Ë¥µ‰∫Ü", pinyin: "T√†i gu√¨ le" },
            { ru: "–°—á—ë—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞", cn: "‰π∞Âçï", pinyin: "M«éidƒÅn" }
        ];

        // --- STATE ---
        let map;
        let markersCluster;
        let currentLoc = null;
        let routingControl = null;
        
        // Standard Pin Icon
        const standardIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // --- INIT ---
        window.onload = function() {
            initMap();
            // Start with All
            renderMarkers('all');
            renderFood();
            renderPhrases();
        };

        // --- MAP LOGIC ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([18.2528, 109.5119], 11);

            L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Cluster group handles performance
            markersCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50
            });
            map.addLayer(markersCluster);
        }

        function generateBillionPlaces() {
            const centerLat = 18.25;
            const centerLng = 109.51;
            for (let i = 0; i < 2000; i++) {
                const lat = centerLat + (Math.random() - 0.5) * 0.4;
                const lng = centerLng + (Math.random() - 0.5) * 0.6;
                const marker = L.marker([lat, lng], { icon: standardIcon });
                marker.bindPopup(`<b>–°–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ #${i+1}</b><br>–ü—Ä–æ—Å—Ç–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞`);
                markersCluster.addLayer(marker);
            }
        }

        function renderMarkers(filter) {
            markersCluster.clearLayers();
            
            // Add fake 2000 places ONLY if filter is "All"
            if(filter === 'all') {
                generateBillionPlaces();
            }

            // Add real Main Locations
            mainLocations.forEach(loc => {
                if (filter === 'all' || loc.type === filter) {
                    const marker = L.marker([loc.lat, loc.lng], { icon: standardIcon }); 
                    marker.on('click', () => openDrawer(loc));
                    markersCluster.addLayer(marker);
                }
            });
        }

        function filterMap(type, el) {
            document.querySelectorAll('.map-filters .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMarkers(type);
        }

        function jumpToMap(lat, lng, name) {
            // Need to find the map button in bottom nav
            switchView('map', document.querySelector('.nav-item:first-child'));
            setTimeout(() => {
                map.flyTo([lat, lng], 14);
                L.popup().setLatLng([lat, lng]).setContent(name).openOn(map);
            }, 300);
        }

        // --- DRAWER ---
        function openDrawer(loc) {
            currentLoc = loc;
            document.getElementById('loc-name').innerText = loc.name;
            document.getElementById('loc-cn').innerText = loc.cn;
            document.getElementById('location-drawer').classList.add('open');
            map.panTo([loc.lat, loc.lng]);
        }
        function closeDrawer() {
            document.getElementById('location-drawer').classList.remove('open');
        }

        // --- ROUTING ---
        function buildRouteToLoc() {
            if (!currentLoc) return;
            closeDrawer();
            const startPoint = L.latLng(18.2528, 109.5119);
            const endPoint = L.latLng(currentLoc.lat, currentLoc.lng);
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [startPoint, endPoint],
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: { styles: [{color: '#4285F4', opacity: 0.8, weight: 6}] },
                createMarker: function() { return null; }
            }).addTo(map);
        }

        // --- THEME & UI ---
        function toggleTheme(isAdventure) {
            if(isAdventure) document.body.classList.add('adventure-mode');
            else document.body.classList.remove('adventure-mode');
        }

        function switchView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ (—ç—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è), –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ—ë
            // –ï—Å–ª–∏ null (–Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑ —Ö–µ–¥–µ—Ä–∞), —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            if(btn) {
                btn.classList.add('active');
            }

            closePanel('search');
            closePanel('settings');
            
            if(viewId === 'map' && map) setTimeout(() => map.invalidateSize(), 200);
        }

        function togglePanel(panelId) {
            const p = document.getElementById(panelId + '-panel');
            const isOpen = p.classList.contains('open');
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('open'));
            if(!isOpen) p.classList.add('open');
        }
        function closePanel(id) { document.getElementById(id+'-panel').classList.remove('open'); }

        // --- RENDERERS ---
        function renderFood() {
            document.getElementById('food-list').innerHTML = foods.map(f => `
                <div class="card-item">
                    <div style="display:flex; gap:15px; align-items:center;">
                        <div style="font-size:2.5rem;">${f.icon}</div>
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; color:var(--text-color);">${f.name}</div>
                            <div class="big-cn-text" style="font-size:1.4rem; margin:4px 0;">${f.cn}</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="speak('${f.cn}')">
                        <i class="fas fa-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å
                    </button>
                </div>
            `).join('');
        }

        function renderPhrases() {
            document.getElementById('phrases-list').innerHTML = phrases.map(p => `
                <div class="card-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:500; color:var(--text-color);">${p.ru}</div>
                        <div style="color:var(--text-secondary); font-size:0.9rem;">${p.pinyin}</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-taxi" style="padding:8px 12px;" onclick="showFullscreen('${p.cn}')"><i class="fas fa-expand"></i></button>
                        <button class="btn btn-primary" style="padding:8px 12px;" onclick="speak('${p.cn}')"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILS ---
        function showTaxiBig() { if(currentLoc) showFullscreen(currentLoc.cn); }
        function showFullscreen(text) {
            document.getElementById('fs-content').innerText = text;
            document.getElementById('fs-modal').classList.add('active');
        }
        function closeFsModal() { document.getElementById('fs-modal').classList.remove('active'); }
        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
